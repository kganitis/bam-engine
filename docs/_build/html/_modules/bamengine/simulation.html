

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>bamengine.simulation &mdash; BAM Engine 0.1.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css?v=d2d258e8" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css?v=f4aeca0c" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=a58bc63e"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            BAM Engine
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html#requirements">Requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html#install-from-pypi">Install from PyPI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html#install-from-source">Install from source</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Quickstart</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../quickstart.html#basic-simulation">Basic Simulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../quickstart.html#collecting-results">Collecting Results</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../quickstart.html#configuration">Configuration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../user_guide/index.html">User Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/index.html#topics">Topics</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../auto_examples/index.html">Examples Gallery</a><ul class="simple">
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../auto_examples/index.html#advanced-examples">Advanced Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../auto_examples/index.html#basic-examples">Basic Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../auto_examples/index.html#research-examples">Research Examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../auto_examples/advanced/index.html">Advanced Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../auto_examples/basic/index.html">Basic Examples</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../auto_examples/basic/example_hello_world.html">Hello BAM Engine</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../auto_examples/basic/example_hello_world.html#initialize-and-run">Initialize and Run</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../auto_examples/basic/example_hello_world.html#visualize-unemployment">Visualize Unemployment</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../auto_examples/basic/example_configuration.html">Configuring Your Simulation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../auto_examples/basic/example_configuration.html#basic-configuration">Basic Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../auto_examples/basic/example_configuration.html#economic-parameters">Economic Parameters</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../auto_examples/basic/example_configuration.html#initial-conditions">Initial Conditions</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../auto_examples/basic/example_configuration.html#compare-scenarios">Compare Scenarios</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../auto_examples/basic/example_configuration.html#visualize-comparison">Visualize Comparison</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../auto_examples/basic/example_configuration.html#summary-statistics">Summary Statistics</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../auto_examples/basic/example_configuration.html#available-parameters">Available Parameters</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../auto_examples/basic/example_baseline_scenario.html">BAM Baseline Scenario (3.9.1)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../auto_examples/basic/example_baseline_scenario.html#initialize-the-simulation">Initialize the Simulation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../auto_examples/basic/example_baseline_scenario.html#run-simulation-and-collect-data">Run Simulation and Collect Data</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../auto_examples/basic/example_baseline_scenario.html#prepare-data-for-visualization">Prepare Data for Visualization</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../auto_examples/basic/example_baseline_scenario.html#visualize-key-economic-indicators">Visualize Key Economic Indicators</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../auto_examples/basic/example_baseline_scenario.html#summary-statistics">Summary Statistics</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../auto_examples/research/index.html">Research Examples</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api/index.html#core-classes">Core Classes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/generated/bamengine.Simulation.html">bamengine.Simulation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/generated/bamengine.Simulation.html#bamengine.Simulation"><code class="docutils literal notranslate"><span class="pre">Simulation</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/generated/bamengine.SimulationResults.html">bamengine.SimulationResults</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/generated/bamengine.SimulationResults.html#bamengine.SimulationResults"><code class="docutils literal notranslate"><span class="pre">SimulationResults</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../api/index.html#ecs-components">ECS Components</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/generated/bamengine.Role.html">bamengine.Role</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/generated/bamengine.Role.html#bamengine.Role"><code class="docutils literal notranslate"><span class="pre">Role</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/generated/bamengine.Event.html">bamengine.Event</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/generated/bamengine.Event.html#bamengine.Event"><code class="docutils literal notranslate"><span class="pre">Event</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/generated/bamengine.Relationship.html">bamengine.Relationship</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/generated/bamengine.Relationship.html#bamengine.Relationship"><code class="docutils literal notranslate"><span class="pre">Relationship</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../api/index.html#type-system">Type System</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/generated/bamengine.Float.html">bamengine.Float</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/generated/bamengine.Float.html#bamengine.Float"><code class="docutils literal notranslate"><span class="pre">Float</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/generated/bamengine.Int.html">bamengine.Int</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/generated/bamengine.Int.html#bamengine.Int"><code class="docutils literal notranslate"><span class="pre">Int</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/generated/bamengine.Bool.html">bamengine.Bool</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/generated/bamengine.Bool.html#bamengine.Bool"><code class="docutils literal notranslate"><span class="pre">Bool</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/generated/bamengine.AgentId.html">bamengine.AgentId</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/generated/bamengine.AgentId.html#bamengine.AgentId"><code class="docutils literal notranslate"><span class="pre">AgentId</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../contributing.html#getting-started">Getting Started</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../contributing.html#code-style">Code Style</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../changelog.html#unreleased">[Unreleased]</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../changelog.html#added">Added</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../changelog.html#id1">[0.1.1] - 2024-11</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">BAM Engine</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">bamengine.simulation</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for bamengine.simulation</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Main simulation facade for BAM Engine.</span>

<span class="sd">This module provides the Simulation class, the primary interface for running</span>
<span class="sd">BAM (Bottom-Up Adaptive Macroeconomics) simulations. The Simulation class</span>
<span class="sd">manages the economy state, agent roles, event pipeline, and provides methods</span>
<span class="sd">for stepping through periods.</span>

<span class="sd">Key Features</span>
<span class="sd">------------</span>
<span class="sd">- Three-tier configuration precedence (defaults → user config → kwargs)</span>
<span class="sd">- Deterministic random number generation with seed control</span>
<span class="sd">- Event pipeline with explicit ordering and YAML configuration</span>
<span class="sd">- Getter methods for roles, events, and relationships (case-insensitive)</span>
<span class="sd">- In-place state mutation for memory efficiency</span>
<span class="sd">- Built-in logging configuration at global and per-event levels</span>

<span class="sd">Classes</span>
<span class="sd">-------</span>
<span class="sd">Simulation</span>
<span class="sd">    Main simulation facade for initializing and running BAM simulations.</span>

<span class="sd">Functions</span>
<span class="sd">---------</span>
<span class="sd">_read_yaml</span>
<span class="sd">    Load configuration from YAML file, dict, or None.</span>
<span class="sd">_package_defaults</span>
<span class="sd">    Load default configuration from bamengine/config/defaults.yml.</span>
<span class="sd">_validate_float1d</span>
<span class="sd">    Validate 1D float array or scalar for initialization.</span>

<span class="sd">See Also</span>
<span class="sd">--------</span>
<span class="sd">bamengine.config : Configuration dataclass and validation</span>
<span class="sd">bamengine.core : Event and Pipeline infrastructure</span>
<span class="sd">bamengine.roles : Agent role components (Producer, Worker, etc.)</span>
<span class="sd">bamengine.events : Event classes wrapping system functions</span>

<span class="sd">Examples</span>
<span class="sd">--------</span>
<span class="sd">Basic simulation with default configuration:</span>

<span class="sd">&gt;&gt;&gt; import bamengine as bam</span>
<span class="sd">&gt;&gt;&gt; sim = bam.Simulation.init(seed=42)</span>
<span class="sd">&gt;&gt;&gt; sim.run(n_periods=100)</span>
<span class="sd">&gt;&gt;&gt; unemployment = sim.ec.unemp_rate_history[-1]</span>

<span class="sd">Custom configuration via YAML file:</span>

<span class="sd">&gt;&gt;&gt; sim = bam.Simulation.init(config=&quot;my_config.yml&quot;, seed=42)</span>
<span class="sd">&gt;&gt;&gt; sim.run(n_periods=100)</span>

<span class="sd">Override specific parameters via kwargs:</span>

<span class="sd">&gt;&gt;&gt; sim = bam.Simulation.init(n_firms=200, n_households=1000, seed=42)</span>
<span class="sd">&gt;&gt;&gt; sim.run(n_periods=100)</span>

<span class="sd">Step-by-step execution with intermediate analysis:</span>

<span class="sd">&gt;&gt;&gt; sim = bam.Simulation.init(seed=42)</span>
<span class="sd">&gt;&gt;&gt; for period in range(100):</span>
<span class="sd">...     sim.step()</span>
<span class="sd">...     if period % 10 == 0:</span>
<span class="sd">...         print(f&quot;Period {period}: Unemployment = {sim.ec.unemp_rate_history[-1]:.2%}&quot;)</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">importlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">resources</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">bamengine.results</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimulationResults</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">bamengine.events</span>  <span class="c1"># noqa: F401 - needed to register events</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bamengine</span><span class="w"> </span><span class="kn">import</span> <span class="n">Rng</span><span class="p">,</span> <span class="n">logging</span><span class="p">,</span> <span class="n">make_rng</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bamengine.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bamengine.core.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span><span class="p">,</span> <span class="n">create_default_pipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bamengine.economy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Economy</span>

<span class="c1"># Import roles BEFORE relationships (LoanBook needs roles to be registered first)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bamengine.roles</span><span class="w"> </span><span class="kn">import</span> <span class="n">Borrower</span><span class="p">,</span> <span class="n">Consumer</span><span class="p">,</span> <span class="n">Employer</span><span class="p">,</span> <span class="n">Lender</span><span class="p">,</span> <span class="n">Producer</span><span class="p">,</span> <span class="n">Worker</span>

<span class="c1"># isort: off</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bamengine.relationships</span><span class="w"> </span><span class="kn">import</span> <span class="n">LoanBook</span>  <span class="c1"># Must import after roles</span>

<span class="c1"># isort: on</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bamengine.typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Float1D</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Simulation&quot;</span><span class="p">]</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="c1"># helpers</span>
<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_read_yaml</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">|</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load configuration from YAML file, dict, or None.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    obj : str, Path, Mapping, or None</span>
<span class="sd">        Configuration source (file path, dict, or None).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Configuration dictionary (empty dict if obj is None).</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    TypeError</span>
<span class="sd">        If YAML root is not a mapping.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">p</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;rt&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;config root must be mapping, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_package_defaults</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load default configuration from bamengine/config/defaults.yml.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Default configuration parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">txt</span> <span class="o">=</span> <span class="n">resources</span><span class="o">.</span><span class="n">files</span><span class="p">(</span><span class="s2">&quot;bamengine&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;config/defaults.yml&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_validate_float1d</span><span class="p">(</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">arr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">Float1D</span><span class="p">,</span>
    <span class="n">expected_len</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">Float1D</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate 1D float array or scalar for initialization.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">        Parameter name for error messages.</span>
<span class="sd">    arr : float or Float1D</span>
<span class="sd">        Scalar or 1D array to validate.</span>
<span class="sd">    expected_len : int</span>
<span class="sd">        Required array length (ignored for scalars).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float or Float1D</span>
<span class="sd">        Validated scalar or array.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If array has wrong shape or length.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>  <span class="c1"># type: ignore[arg-type]</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">arr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">expected_len</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">!s}</span><span class="s2"> must be length-</span><span class="si">{</span><span class="n">expected_len</span><span class="si">}</span><span class="s2"> 1-D array &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;(got shape=</span><span class="si">{</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">arr</span>


<span class="c1"># Simulation</span>
<span class="c1"># ---------------------------------------------------------------------</span>
<div class="viewcode-block" id="Simulation">
<a class="viewcode-back" href="../../api/generated/bamengine.Simulation.html#bamengine.Simulation">[docs]</a>
<span class="nd">@dataclass</span><span class="p">(</span><span class="n">slots</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Simulation</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main simulation facade for BAM Engine.</span>

<span class="sd">    The Simulation class is the primary interface for running BAM (Bottom-Up Adaptive</span>
<span class="sd">    Macroeconomics) simulations. It manages the economy state, agent roles, event pipeline,</span>
<span class="sd">    and provides methods for stepping through periods.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    ec : Economy</span>
<span class="sd">        Global economy state (prices, wages, histories).</span>
<span class="sd">    config : Config</span>
<span class="sd">        Configuration parameters for the simulation.</span>
<span class="sd">    rng : np.random.Generator</span>
<span class="sd">        Random number generator for deterministic simulations.</span>
<span class="sd">    n_firms : int</span>
<span class="sd">        Number of firms in the economy.</span>
<span class="sd">    n_households : int</span>
<span class="sd">        Number of households in the economy.</span>
<span class="sd">    n_banks : int</span>
<span class="sd">        Number of banks in the economy.</span>
<span class="sd">    prod : Producer</span>
<span class="sd">        Producer role (firm production state).</span>
<span class="sd">    wrk : Worker</span>
<span class="sd">        Worker role (household employment state).</span>
<span class="sd">    emp : Employer</span>
<span class="sd">        Employer role (firm hiring state).</span>
<span class="sd">    bor : Borrower</span>
<span class="sd">        Borrower role (firm financial state).</span>
<span class="sd">    lend : Lender</span>
<span class="sd">        Lender role (bank state).</span>
<span class="sd">    con : Consumer</span>
<span class="sd">        Consumer role (household consumption state).</span>
<span class="sd">    pipeline : Pipeline</span>
<span class="sd">        Event pipeline controlling simulation execution order.</span>
<span class="sd">    lb : LoanBook</span>
<span class="sd">        Loan relationship between borrowers and lenders.</span>
<span class="sd">    n_periods : int</span>
<span class="sd">        Default run length for run() method.</span>
<span class="sd">    t : int</span>
<span class="sd">        Current period (starts at 0).</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    Basic usage with default configuration:</span>

<span class="sd">    &gt;&gt;&gt; import bamengine as bam</span>
<span class="sd">    &gt;&gt;&gt; sim = bam.Simulation.init(seed=42)</span>
<span class="sd">    &gt;&gt;&gt; sim.run(n_periods=100)</span>
<span class="sd">    &gt;&gt;&gt; unemployment = sim.ec.unemp_rate_history[-1]</span>
<span class="sd">    &gt;&gt;&gt; print(f&quot;Final unemployment: {unemployment:.2%}&quot;)</span>
<span class="sd">    Final unemployment: 0.04%</span>

<span class="sd">    Override configuration parameters:</span>

<span class="sd">    &gt;&gt;&gt; sim = bam.Simulation.init(</span>
<span class="sd">    ...     n_firms=200,</span>
<span class="sd">    ...     n_households=1000,</span>
<span class="sd">    ...     n_banks=15,</span>
<span class="sd">    ...     seed=42</span>
<span class="sd">    ... )</span>
<span class="sd">    &gt;&gt;&gt; sim.step()  # Single period</span>
<span class="sd">    &gt;&gt;&gt; sim.t</span>
<span class="sd">    1</span>

<span class="sd">    Use custom configuration file:</span>

<span class="sd">    &gt;&gt;&gt; sim = bam.Simulation.init(config=&quot;my_config.yml&quot;, seed=42)</span>
<span class="sd">    &gt;&gt;&gt; sim.run(n_periods=50)</span>

<span class="sd">    Access roles and inspect state:</span>

<span class="sd">    &gt;&gt;&gt; sim = bam.Simulation.init(seed=42)</span>
<span class="sd">    &gt;&gt;&gt; sim.step()</span>
<span class="sd">    &gt;&gt;&gt; prod = sim.get_role(&quot;Producer&quot;)</span>
<span class="sd">    &gt;&gt;&gt; avg_price = prod.price.mean()</span>
<span class="sd">    &gt;&gt;&gt; print(f&quot;Average price: {avg_price:.2f}&quot;)</span>
<span class="sd">    Average price: 1.50</span>

<span class="sd">    Custom pipeline:</span>

<span class="sd">    &gt;&gt;&gt; sim = bam.Simulation.init(</span>
<span class="sd">    ...     pipeline_path=&quot;custom_pipeline.yml&quot;,</span>
<span class="sd">    ...     seed=42</span>
<span class="sd">    ... )</span>
<span class="sd">    &gt;&gt;&gt; sim.run(n_periods=100)</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - All simulations are deterministic when seed is specified</span>
<span class="sd">    - State is mutated in-place during step() and run()</span>
<span class="sd">    - Agent roles share NumPy arrays for memory efficiency</span>
<span class="sd">    - Pipeline execution order can be customized via YAML files</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    init : Class method to create Simulation instances</span>
<span class="sd">    step : Execute one simulation period</span>
<span class="sd">    run : Execute multiple periods</span>
<span class="sd">    get_role : Access role instances</span>
<span class="sd">    get_event : Access event instances</span>
<span class="sd">    Pipeline : Event pipeline configuration</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Economy instance</span>
    <span class="n">ec</span><span class="p">:</span> <span class="n">Economy</span>

    <span class="c1"># configuration</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Config</span>
    <span class="n">rng</span><span class="p">:</span> <span class="n">Rng</span>

    <span class="c1"># population sizes</span>
    <span class="n">n_firms</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">n_households</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">n_banks</span><span class="p">:</span> <span class="nb">int</span>

    <span class="c1"># roles</span>
    <span class="n">prod</span><span class="p">:</span> <span class="n">Producer</span>
    <span class="n">wrk</span><span class="p">:</span> <span class="n">Worker</span>
    <span class="n">emp</span><span class="p">:</span> <span class="n">Employer</span>
    <span class="n">bor</span><span class="p">:</span> <span class="n">Borrower</span>
    <span class="n">lend</span><span class="p">:</span> <span class="n">Lender</span>
    <span class="n">con</span><span class="p">:</span> <span class="n">Consumer</span>

    <span class="c1"># event pipeline</span>
    <span class="n">pipeline</span><span class="p">:</span> <span class="n">Pipeline</span>

    <span class="c1"># relationships</span>
    <span class="n">lb</span><span class="p">:</span> <span class="n">LoanBook</span>

    <span class="c1"># periods</span>
    <span class="n">n_periods</span><span class="p">:</span> <span class="nb">int</span>  <span class="c1"># run length</span>
    <span class="n">t</span><span class="p">:</span> <span class="nb">int</span>  <span class="c1"># current period</span>

    <span class="c1"># Backward-compatible properties (delegate to config)</span>
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">h_rho</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Max production-growth shock.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">h_rho</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">h_xi</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Max wage-growth shock.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">h_xi</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">h_phi</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Max bank operational costs shock.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">h_phi</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">h_eta</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Max price-growth shock.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">h_eta</span>
        <span class="p">)</span>  <span class="c1"># pragma: no cover - convenience accessor, tested via config</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">max_M</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Max job applications per unemployed worker.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_M</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">max_H</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Max loan applications per firm.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_H</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">max_Z</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Max firm visits per consumer.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_Z</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">theta</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Job contract length θ.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">theta</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">beta</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Propensity to consume exponent β.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">beta</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">delta</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dividend payout ratio δ (DPR).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">delta</span>
        <span class="p">)</span>  <span class="c1"># pragma: no cover - convenience accessor, tested via config</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">r_bar</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Baseline interest rate r̄.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">r_bar</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">v</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Bank capital requirement coefficient v.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">v</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cap_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Breakeven price cap factor.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cap_factor</span>

    <span class="c1"># Constructor</span>
    <span class="c1"># ---------------------------------------------------------------------</span>
<div class="viewcode-block" id="Simulation.init">
<a class="viewcode-back" href="../../api/generated/bamengine.Simulation.html#bamengine.Simulation.init">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">|</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">overrides</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>  <span class="c1"># anything here wins last</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Simulation&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new Simulation instance with validated configuration.</span>

<span class="sd">        Configuration parameters are merged from three sources (later overrides earlier):</span>
<span class="sd">        1. Package defaults (bamengine/config/defaults.yml)</span>
<span class="sd">        2. User config (YAML file path, dict, or None)</span>
<span class="sd">        3. Keyword arguments (highest priority)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        config : str, Path, Mapping, or None, optional</span>
<span class="sd">            Configuration source:</span>
<span class="sd">            - str/Path: Path to YAML configuration file</span>
<span class="sd">            - Mapping: Dictionary of configuration parameters</span>
<span class="sd">            - None: Use package defaults only</span>
<span class="sd">        **overrides : Any</span>
<span class="sd">            Configuration parameters to override (highest precedence).</span>
<span class="sd">            Common parameters:</span>
<span class="sd">            - n_firms : int (default: 100)</span>
<span class="sd">            - n_households : int (default: 500)</span>
<span class="sd">            - n_banks : int (default: 10)</span>
<span class="sd">            - seed : int or None (default: None)</span>
<span class="sd">            - pipeline_path : str or None (default: None)</span>
<span class="sd">            - logging : dict (default: {&quot;default_level&quot;: &quot;INFO&quot;})</span>
<span class="sd">            See config/defaults.yml for all parameters.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Simulation</span>
<span class="sd">            Initialized simulation ready to run.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If configuration validation fails (invalid ranges, types, etc.).</span>
<span class="sd">        FileNotFoundError</span>
<span class="sd">            If config file path does not exist.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        Use default configuration:</span>

<span class="sd">        &gt;&gt;&gt; import bamengine as bam</span>
<span class="sd">        &gt;&gt;&gt; sim = bam.Simulation.init(seed=42)</span>
<span class="sd">        &gt;&gt;&gt; sim.n_firms, sim.n_households, sim.n_banks</span>
<span class="sd">        (100, 500, 10)</span>

<span class="sd">        Override population sizes:</span>

<span class="sd">        &gt;&gt;&gt; sim = bam.Simulation.init(</span>
<span class="sd">        ...     n_firms=200,</span>
<span class="sd">        ...     n_households=1000,</span>
<span class="sd">        ...     n_banks=15,</span>
<span class="sd">        ...     seed=42</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; sim.n_firms</span>
<span class="sd">        200</span>

<span class="sd">        Load configuration from file:</span>

<span class="sd">        &gt;&gt;&gt; sim = bam.Simulation.init(config=&quot;my_config.yml&quot;)  # doctest: +SKIP</span>

<span class="sd">        Combine file config with overrides:</span>

<span class="sd">        &gt;&gt;&gt; sim = bam.Simulation.init(  # doctest: +SKIP</span>
<span class="sd">        ...     config=&quot;base_config.yml&quot;,</span>
<span class="sd">        ...     seed=42,</span>
<span class="sd">        ...     n_firms=150</span>
<span class="sd">        ... )</span>

<span class="sd">        Custom pipeline:</span>

<span class="sd">        &gt;&gt;&gt; sim = bam.Simulation.init(</span>
<span class="sd">        ...     pipeline_path=&quot;custom_pipeline.yml&quot;,</span>
<span class="sd">        ...     seed=42</span>
<span class="sd">        ... )  # doctest: +SKIP</span>

<span class="sd">        Configure logging:</span>

<span class="sd">        &gt;&gt;&gt; log_config = {</span>
<span class="sd">        ...     &quot;default_level&quot;: &quot;DEBUG&quot;,</span>
<span class="sd">        ...     &quot;events&quot;: {</span>
<span class="sd">        ...         &quot;firms_adjust_price&quot;: &quot;INFO&quot;,</span>
<span class="sd">        ...         &quot;workers_send_one_round&quot;: &quot;WARNING&quot;</span>
<span class="sd">        ...     }</span>
<span class="sd">        ... }</span>
<span class="sd">        &gt;&gt;&gt; sim = bam.Simulation.init(logging=log_config, seed=42)</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - All configuration is validated before initialization</span>
<span class="sd">        - Invalid parameters raise ValueError with clear error messages</span>
<span class="sd">        - Vector parameters (price_init, net_worth_init, etc.) accept scalars</span>
<span class="sd">          (broadcast to all agents) or 1D arrays of appropriate length</span>
<span class="sd">        - Random seed ensures reproducible simulations</span>
<span class="sd">        - Default pipeline includes 39 events across 8 economic phases</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        Config : Configuration dataclass</span>
<span class="sd">        ConfigValidator : Centralized validation logic</span>
<span class="sd">        Pipeline : Event pipeline configuration</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 1 + 2 + 3 → one merged dict</span>
        <span class="n">cfg_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">_package_defaults</span><span class="p">()</span>
        <span class="n">cfg_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_read_yaml</span><span class="p">(</span><span class="n">config</span><span class="p">))</span>
        <span class="n">cfg_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">overrides</span><span class="p">)</span>

        <span class="c1"># Validate configuration (centralized validation)</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">bamengine.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConfigValidator</span>

        <span class="n">ConfigValidator</span><span class="o">.</span><span class="n">validate_config</span><span class="p">(</span><span class="n">cfg_dict</span><span class="p">)</span>

        <span class="c1"># Validate pipeline path if specified</span>
        <span class="n">pipeline_path</span> <span class="o">=</span> <span class="n">cfg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pipeline_path&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pipeline_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ConfigValidator</span><span class="o">.</span><span class="n">validate_pipeline_path</span><span class="p">(</span><span class="n">pipeline_path</span><span class="p">)</span>
            <span class="c1"># Validate pipeline YAML with available parameters</span>
            <span class="n">ConfigValidator</span><span class="o">.</span><span class="n">validate_pipeline_yaml</span><span class="p">(</span>
                <span class="n">pipeline_path</span><span class="p">,</span>
                <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;max_M&quot;</span><span class="p">:</span> <span class="n">cfg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_M&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                    <span class="s2">&quot;max_H&quot;</span><span class="p">:</span> <span class="n">cfg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_H&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="s2">&quot;max_Z&quot;</span><span class="p">:</span> <span class="n">cfg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_Z&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="p">},</span>
            <span class="p">)</span>

        <span class="c1"># pull required scalars</span>
        <span class="n">n_firms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cfg_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;n_firms&quot;</span><span class="p">))</span>
        <span class="n">n_households</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cfg_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;n_households&quot;</span><span class="p">))</span>
        <span class="n">n_banks</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cfg_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;n_banks&quot;</span><span class="p">))</span>

        <span class="c1"># Random-seed handling</span>
        <span class="n">seed_val</span> <span class="o">=</span> <span class="n">cfg_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;seed&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">rng</span><span class="p">:</span> <span class="n">Rng</span> <span class="o">=</span> <span class="n">seed_val</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">seed_val</span><span class="p">,</span> <span class="n">Rng</span><span class="p">)</span> <span class="k">else</span> <span class="n">make_rng</span><span class="p">(</span><span class="n">seed_val</span><span class="p">)</span>

        <span class="c1"># vector params (validate size)</span>
        <span class="n">cfg_dict</span><span class="p">[</span><span class="s2">&quot;net_worth_init&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_validate_float1d</span><span class="p">(</span>
            <span class="s2">&quot;net_worth_init&quot;</span><span class="p">,</span> <span class="n">cfg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;net_worth_init&quot;</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">),</span> <span class="n">n_firms</span>
        <span class="p">)</span>
        <span class="n">cfg_dict</span><span class="p">[</span><span class="s2">&quot;production_init&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_validate_float1d</span><span class="p">(</span>
            <span class="s2">&quot;production_init&quot;</span><span class="p">,</span> <span class="n">cfg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;production_init&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">n_firms</span>
        <span class="p">)</span>
        <span class="n">cfg_dict</span><span class="p">[</span><span class="s2">&quot;price_init&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_validate_float1d</span><span class="p">(</span>
            <span class="s2">&quot;price_init&quot;</span><span class="p">,</span> <span class="n">cfg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;price_init&quot;</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">),</span> <span class="n">n_firms</span>
        <span class="p">)</span>
        <span class="n">cfg_dict</span><span class="p">[</span><span class="s2">&quot;wage_offer_init&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_validate_float1d</span><span class="p">(</span>
            <span class="s2">&quot;wage_offer_init&quot;</span><span class="p">,</span> <span class="n">cfg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;wage_offer_init&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">n_firms</span>
        <span class="p">)</span>
        <span class="n">cfg_dict</span><span class="p">[</span><span class="s2">&quot;savings_init&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_validate_float1d</span><span class="p">(</span>
            <span class="s2">&quot;savings_init&quot;</span><span class="p">,</span> <span class="n">cfg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;savings_init&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">n_households</span>
        <span class="p">)</span>
        <span class="n">cfg_dict</span><span class="p">[</span><span class="s2">&quot;equity_base_init&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_validate_float1d</span><span class="p">(</span>
            <span class="s2">&quot;equity_base_init&quot;</span><span class="p">,</span> <span class="n">cfg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;equity_base_init&quot;</span><span class="p">,</span> <span class="mf">10_000.0</span><span class="p">),</span> <span class="n">n_banks</span>
        <span class="p">)</span>

        <span class="c1"># delegate to private constructor</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_from_params</span><span class="p">(</span>
            <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span>
            <span class="n">n_firms</span><span class="o">=</span><span class="n">n_firms</span><span class="p">,</span>
            <span class="n">n_households</span><span class="o">=</span><span class="n">n_households</span><span class="p">,</span>
            <span class="n">n_banks</span><span class="o">=</span><span class="n">n_banks</span><span class="p">,</span>
            <span class="o">**</span><span class="n">cfg_dict</span><span class="p">,</span>  <span class="c1"># all remaining, size-checked parameters</span>
        <span class="p">)</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_configure_logging</span><span class="p">(</span><span class="n">log_config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Configure logging levels for bamengine loggers.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        log_config : dict</span>
<span class="sd">            Logging configuration with keys:</span>
<span class="sd">            - default_level: str (e.g., &#39;INFO&#39;, &#39;DEBUG&#39;, &#39;TRACE&#39;)</span>
<span class="sd">            - events: dict[str, str] (per-event overrides)</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Supports standard Python logging levels (DEBUG, INFO, WARNING, ERROR,</span>
<span class="sd">        CRITICAL) plus custom TRACE level (5) for fine-grained debugging.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Map level names to numeric values</span>
        <span class="c1"># Include standard levels + custom TRACE</span>
        <span class="n">level_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;TRACE&quot;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">TRACE</span><span class="p">,</span>
            <span class="s2">&quot;DEBUG&quot;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
            <span class="s2">&quot;INFO&quot;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="s2">&quot;WARNING&quot;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">,</span>
            <span class="s2">&quot;ERROR&quot;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
            <span class="s2">&quot;CRITICAL&quot;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Set default level for bamengine logger</span>
        <span class="n">default_level</span> <span class="o">=</span> <span class="n">log_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default_level&quot;</span><span class="p">,</span> <span class="s2">&quot;INFO&quot;</span><span class="p">)</span>
        <span class="n">level_value</span> <span class="o">=</span> <span class="n">level_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">default_level</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;bamengine&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">level_value</span><span class="p">)</span>

        <span class="c1"># Set per-event log level overrides</span>
        <span class="n">event_levels</span> <span class="o">=</span> <span class="n">log_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;events&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">for</span> <span class="n">event_name</span><span class="p">,</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">event_levels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">logger_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;bamengine.events.</span><span class="si">{</span><span class="n">event_name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">level_value</span> <span class="o">=</span> <span class="n">level_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">logger_name</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">level_value</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_from_params</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">rng</span><span class="p">:</span> <span class="n">Rng</span><span class="p">,</span> <span class="o">**</span><span class="n">p</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Simulation&quot;</span><span class="p">:</span>  <span class="c1"># noqa: C901</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Internal factory method to construct Simulation from validated config dict.</span>

<span class="sd">        This is an internal method called by `init()` after configuration validation.</span>
<span class="sd">        Users should use `Simulation.init()` instead.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rng : numpy.random.Generator</span>
<span class="sd">            Random number generator for deterministic simulations.</span>
<span class="sd">        **p : Any</span>
<span class="sd">            Validated configuration parameters (keys from Config dataclass).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Simulation</span>
<span class="sd">            Initialized simulation instance.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - Called internally by `init()` after config validation</span>
<span class="sd">        - Initializes all role arrays (Producer, Worker, etc.) from config</span>
<span class="sd">        - Creates default pipeline from YAML if `pipeline_path` not specified</span>
<span class="sd">        - Not intended for direct use by users</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        init : Public factory method for creating Simulation instances</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Vector initilization</span>

        <span class="c1"># finance</span>
        <span class="n">net_worth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;n_firms&quot;</span><span class="p">],</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;net_worth_init&quot;</span><span class="p">])</span>
        <span class="n">total_funds</span> <span class="o">=</span> <span class="n">net_worth</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">rnd_intensity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;n_firms&quot;</span><span class="p">])</span>
        <span class="n">gross_profit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">net_worth</span><span class="p">)</span>
        <span class="n">net_profit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">net_worth</span><span class="p">)</span>
        <span class="n">retained_profit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">net_worth</span><span class="p">)</span>

        <span class="c1"># producer</span>
        <span class="n">price</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;n_firms&quot;</span><span class="p">],</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;price_init&quot;</span><span class="p">])</span>
        <span class="n">production</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;n_firms&quot;</span><span class="p">],</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;production_init&quot;</span><span class="p">])</span>
        <span class="n">inventory</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">production</span><span class="p">)</span>
        <span class="n">expected_demand</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">production</span><span class="p">)</span>
        <span class="n">desired_production</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">production</span><span class="p">)</span>
        <span class="n">labor_productivity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;n_firms&quot;</span><span class="p">])</span>
        <span class="n">breakeven_price</span> <span class="o">=</span> <span class="n">price</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># employer</span>
        <span class="n">current_labor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;n_firms&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="n">desired_labor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">current_labor</span><span class="p">)</span>
        <span class="n">wage_offer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;n_firms&quot;</span><span class="p">],</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;wage_offer_init&quot;</span><span class="p">])</span>
        <span class="n">wage_bill</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">wage_offer</span><span class="p">)</span>
        <span class="n">n_vacancies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">desired_labor</span><span class="p">)</span>
        <span class="n">recv_job_apps_head</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;n_firms&quot;</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="n">recv_job_apps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;n_firms&quot;</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;n_households&quot;</span><span class="p">]),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>

        <span class="c1"># worker</span>
        <span class="n">employer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;n_households&quot;</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="n">employer_prev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">employer</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">periods_left</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;n_households&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="n">contract_expired</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;n_households&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">)</span>
        <span class="n">fired</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;n_households&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">)</span>
        <span class="n">wage</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;n_households&quot;</span><span class="p">])</span>
        <span class="n">job_apps_head</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;n_households&quot;</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="n">job_apps_targets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;n_households&quot;</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;max_M&quot;</span><span class="p">]),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>

        <span class="c1"># borrower</span>
        <span class="n">credit_demand</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">net_worth</span><span class="p">)</span>
        <span class="n">projected_fragility</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;n_firms&quot;</span><span class="p">])</span>
        <span class="n">loan_apps_head</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;n_firms&quot;</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="n">loan_apps_targets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;n_firms&quot;</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;max_H&quot;</span><span class="p">]),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>

        <span class="c1"># lender</span>
        <span class="n">equity_base</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;n_banks&quot;</span><span class="p">],</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;equity_base_init&quot;</span><span class="p">])</span>
        <span class="c1"># noinspection DuplicatedCode</span>
        <span class="n">credit_supply</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">equity_base</span><span class="p">)</span>
        <span class="n">interest_rate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;n_banks&quot;</span><span class="p">])</span>
        <span class="n">recv_loan_apps_head</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;n_banks&quot;</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="n">recv_loan_apps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;n_banks&quot;</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;n_firms&quot;</span><span class="p">]),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>

        <span class="c1"># consumer</span>
        <span class="n">income</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">wage</span><span class="p">)</span>
        <span class="n">savings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">income</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;savings_init&quot;</span><span class="p">])</span>
        <span class="n">income_to_spend</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">income</span><span class="p">)</span>
        <span class="n">propensity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;n_households&quot;</span><span class="p">])</span>
        <span class="n">largest_prod_prev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;n_households&quot;</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="n">shop_visits_head</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;n_households&quot;</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="n">shop_visits_targets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span>
            <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;n_households&quot;</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;max_Z&quot;</span><span class="p">]),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span>
        <span class="p">)</span>

        <span class="c1"># economy level scalars &amp; time-series</span>
        <span class="n">avg_mkt_price</span> <span class="o">=</span> <span class="n">price</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">avg_mkt_price_history</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">avg_mkt_price</span><span class="p">])</span>
        <span class="n">unemp_rate_history</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">])</span>
        <span class="n">inflation_history</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">])</span>

        <span class="c1"># Wrap into components</span>
        <span class="c1"># -----------------------------------------------------------------</span>
        <span class="n">ec</span> <span class="o">=</span> <span class="n">Economy</span><span class="p">(</span>
            <span class="n">avg_mkt_price</span><span class="o">=</span><span class="n">avg_mkt_price</span><span class="p">,</span>
            <span class="n">min_wage</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;min_wage&quot;</span><span class="p">],</span>
            <span class="n">min_wage_rev_period</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;min_wage_rev_period&quot;</span><span class="p">],</span>
            <span class="n">avg_mkt_price_history</span><span class="o">=</span><span class="n">avg_mkt_price_history</span><span class="p">,</span>
            <span class="n">unemp_rate_history</span><span class="o">=</span><span class="n">unemp_rate_history</span><span class="p">,</span>
            <span class="n">inflation_history</span><span class="o">=</span><span class="n">inflation_history</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">prod</span> <span class="o">=</span> <span class="n">Producer</span><span class="p">(</span>
            <span class="n">price</span><span class="o">=</span><span class="n">price</span><span class="p">,</span>
            <span class="n">production</span><span class="o">=</span><span class="n">production</span><span class="p">,</span>
            <span class="n">inventory</span><span class="o">=</span><span class="n">inventory</span><span class="p">,</span>
            <span class="n">expected_demand</span><span class="o">=</span><span class="n">expected_demand</span><span class="p">,</span>
            <span class="n">desired_production</span><span class="o">=</span><span class="n">desired_production</span><span class="p">,</span>
            <span class="n">labor_productivity</span><span class="o">=</span><span class="n">labor_productivity</span><span class="p">,</span>
            <span class="n">breakeven_price</span><span class="o">=</span><span class="n">breakeven_price</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">wrk</span> <span class="o">=</span> <span class="n">Worker</span><span class="p">(</span>
            <span class="n">employer</span><span class="o">=</span><span class="n">employer</span><span class="p">,</span>
            <span class="n">employer_prev</span><span class="o">=</span><span class="n">employer_prev</span><span class="p">,</span>
            <span class="n">wage</span><span class="o">=</span><span class="n">wage</span><span class="p">,</span>
            <span class="n">periods_left</span><span class="o">=</span><span class="n">periods_left</span><span class="p">,</span>
            <span class="n">contract_expired</span><span class="o">=</span><span class="n">contract_expired</span><span class="p">,</span>
            <span class="n">fired</span><span class="o">=</span><span class="n">fired</span><span class="p">,</span>
            <span class="n">job_apps_head</span><span class="o">=</span><span class="n">job_apps_head</span><span class="p">,</span>
            <span class="n">job_apps_targets</span><span class="o">=</span><span class="n">job_apps_targets</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">emp</span> <span class="o">=</span> <span class="n">Employer</span><span class="p">(</span>
            <span class="n">desired_labor</span><span class="o">=</span><span class="n">desired_labor</span><span class="p">,</span>
            <span class="n">current_labor</span><span class="o">=</span><span class="n">current_labor</span><span class="p">,</span>
            <span class="n">wage_offer</span><span class="o">=</span><span class="n">wage_offer</span><span class="p">,</span>
            <span class="n">wage_bill</span><span class="o">=</span><span class="n">wage_bill</span><span class="p">,</span>
            <span class="n">n_vacancies</span><span class="o">=</span><span class="n">n_vacancies</span><span class="p">,</span>
            <span class="n">total_funds</span><span class="o">=</span><span class="n">total_funds</span><span class="p">,</span>
            <span class="n">recv_job_apps_head</span><span class="o">=</span><span class="n">recv_job_apps_head</span><span class="p">,</span>
            <span class="n">recv_job_apps</span><span class="o">=</span><span class="n">recv_job_apps</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">bor</span> <span class="o">=</span> <span class="n">Borrower</span><span class="p">(</span>
            <span class="n">net_worth</span><span class="o">=</span><span class="n">net_worth</span><span class="p">,</span>
            <span class="n">total_funds</span><span class="o">=</span><span class="n">total_funds</span><span class="p">,</span>
            <span class="n">wage_bill</span><span class="o">=</span><span class="n">wage_bill</span><span class="p">,</span>
            <span class="n">credit_demand</span><span class="o">=</span><span class="n">credit_demand</span><span class="p">,</span>
            <span class="n">rnd_intensity</span><span class="o">=</span><span class="n">rnd_intensity</span><span class="p">,</span>
            <span class="n">gross_profit</span><span class="o">=</span><span class="n">gross_profit</span><span class="p">,</span>
            <span class="n">net_profit</span><span class="o">=</span><span class="n">net_profit</span><span class="p">,</span>
            <span class="n">retained_profit</span><span class="o">=</span><span class="n">retained_profit</span><span class="p">,</span>
            <span class="n">projected_fragility</span><span class="o">=</span><span class="n">projected_fragility</span><span class="p">,</span>
            <span class="n">loan_apps_head</span><span class="o">=</span><span class="n">loan_apps_head</span><span class="p">,</span>
            <span class="n">loan_apps_targets</span><span class="o">=</span><span class="n">loan_apps_targets</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">lend</span> <span class="o">=</span> <span class="n">Lender</span><span class="p">(</span>
            <span class="n">equity_base</span><span class="o">=</span><span class="n">equity_base</span><span class="p">,</span>
            <span class="n">credit_supply</span><span class="o">=</span><span class="n">credit_supply</span><span class="p">,</span>
            <span class="n">interest_rate</span><span class="o">=</span><span class="n">interest_rate</span><span class="p">,</span>
            <span class="n">recv_loan_apps_head</span><span class="o">=</span><span class="n">recv_loan_apps_head</span><span class="p">,</span>
            <span class="n">recv_loan_apps</span><span class="o">=</span><span class="n">recv_loan_apps</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">con</span> <span class="o">=</span> <span class="n">Consumer</span><span class="p">(</span>
            <span class="n">income</span><span class="o">=</span><span class="n">income</span><span class="p">,</span>
            <span class="n">savings</span><span class="o">=</span><span class="n">savings</span><span class="p">,</span>
            <span class="n">income_to_spend</span><span class="o">=</span><span class="n">income_to_spend</span><span class="p">,</span>
            <span class="n">propensity</span><span class="o">=</span><span class="n">propensity</span><span class="p">,</span>
            <span class="n">largest_prod_prev</span><span class="o">=</span><span class="n">largest_prod_prev</span><span class="p">,</span>
            <span class="n">shop_visits_head</span><span class="o">=</span><span class="n">shop_visits_head</span><span class="p">,</span>
            <span class="n">shop_visits_targets</span><span class="o">=</span><span class="n">shop_visits_targets</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Create config object</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span>
            <span class="n">h_rho</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;h_rho&quot;</span><span class="p">],</span>
            <span class="n">h_xi</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;h_xi&quot;</span><span class="p">],</span>
            <span class="n">h_phi</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;h_phi&quot;</span><span class="p">],</span>
            <span class="n">h_eta</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;h_eta&quot;</span><span class="p">],</span>
            <span class="n">max_M</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;max_M&quot;</span><span class="p">],</span>
            <span class="n">max_H</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;max_H&quot;</span><span class="p">],</span>
            <span class="n">max_Z</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;max_Z&quot;</span><span class="p">],</span>
            <span class="n">theta</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;theta&quot;</span><span class="p">],</span>
            <span class="n">beta</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">],</span>
            <span class="n">delta</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;delta&quot;</span><span class="p">],</span>
            <span class="n">r_bar</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;r_bar&quot;</span><span class="p">],</span>
            <span class="n">v</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;v&quot;</span><span class="p">],</span>
            <span class="n">cap_factor</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cap_factor&quot;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Create event pipeline (default or custom)</span>
        <span class="n">pipeline_path</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pipeline_path&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pipeline_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">bamengine.core.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span>

            <span class="n">pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="o">.</span><span class="n">from_yaml</span><span class="p">(</span>
                <span class="n">pipeline_path</span><span class="p">,</span>
                <span class="n">max_M</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;max_M&quot;</span><span class="p">],</span>
                <span class="n">max_H</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;max_H&quot;</span><span class="p">],</span>
                <span class="n">max_Z</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;max_Z&quot;</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pipeline</span> <span class="o">=</span> <span class="n">create_default_pipeline</span><span class="p">(</span>
                <span class="n">max_M</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;max_M&quot;</span><span class="p">],</span> <span class="n">max_H</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;max_H&quot;</span><span class="p">],</span> <span class="n">max_Z</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;max_Z&quot;</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="c1"># Configure logging (if specified)</span>
        <span class="k">if</span> <span class="s2">&quot;logging&quot;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_configure_logging</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;logging&quot;</span><span class="p">])</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">ec</span><span class="o">=</span><span class="n">ec</span><span class="p">,</span>
            <span class="n">prod</span><span class="o">=</span><span class="n">prod</span><span class="p">,</span>
            <span class="n">wrk</span><span class="o">=</span><span class="n">wrk</span><span class="p">,</span>
            <span class="n">emp</span><span class="o">=</span><span class="n">emp</span><span class="p">,</span>
            <span class="n">bor</span><span class="o">=</span><span class="n">bor</span><span class="p">,</span>
            <span class="n">lend</span><span class="o">=</span><span class="n">lend</span><span class="p">,</span>
            <span class="n">lb</span><span class="o">=</span><span class="n">LoanBook</span><span class="p">(),</span>
            <span class="n">con</span><span class="o">=</span><span class="n">con</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">cfg</span><span class="p">,</span>
            <span class="n">pipeline</span><span class="o">=</span><span class="n">pipeline</span><span class="p">,</span>
            <span class="n">n_firms</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;n_firms&quot;</span><span class="p">],</span>
            <span class="n">n_households</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;n_households&quot;</span><span class="p">],</span>
            <span class="n">n_banks</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;n_banks&quot;</span><span class="p">],</span>
            <span class="n">n_periods</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;n_periods&quot;</span><span class="p">],</span>
            <span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># public API</span>
    <span class="c1"># ---------------------------------------------------------------------</span>
<div class="viewcode-block" id="Simulation.run">
<a class="viewcode-back" href="../../api/generated/bamengine.Simulation.html#bamengine.Simulation.run">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">n_periods</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">collect</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;SimulationResults&quot;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the simulation for multiple periods.</span>

<span class="sd">        Executes the event pipeline for a specified number of periods, advancing</span>
<span class="sd">        the economy state incrementally. If no argument is provided, uses the</span>
<span class="sd">        n_periods value from initialization.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n_periods : int, optional</span>
<span class="sd">            Number of periods to simulate. If None (default), uses the n_periods</span>
<span class="sd">            value passed at initialization via `Simulation.init()`.</span>
<span class="sd">        collect : bool or dict, default=False</span>
<span class="sd">            Whether to collect and return simulation results.</span>

<span class="sd">            - False: No collection, returns None (default)</span>
<span class="sd">            - True: Collect all roles (aggregated means) + economy metrics</span>
<span class="sd">            - dict: Custom collection config with keys:</span>
<span class="sd">                - &#39;roles&#39;: list of role names or None for all</span>
<span class="sd">                - &#39;variables&#39;: dict mapping role -&gt; list of variables</span>
<span class="sd">                - &#39;aggregate&#39;: &#39;mean&#39;, &#39;median&#39;, &#39;sum&#39;, &#39;std&#39;, or None for full</span>
<span class="sd">                - &#39;economy&#39;: bool, include economy metrics (default True)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        SimulationResults or None</span>
<span class="sd">            Results object if collect is truthy, None otherwise.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        Run simulation for 100 periods using default configuration:</span>

<span class="sd">        &gt;&gt;&gt; import bamengine as be</span>
<span class="sd">        &gt;&gt;&gt; sim = be.Simulation.init(seed=42)</span>
<span class="sd">        &gt;&gt;&gt; sim.run(n_periods=100)</span>
<span class="sd">        &gt;&gt;&gt; unemployment = sim.ec.unemp_rate_history[-1]</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;Final unemployment rate: {unemployment:.2%}&quot;)</span>
<span class="sd">        Final unemployment rate: 4.32%</span>

<span class="sd">        Use n_periods from initialization:</span>

<span class="sd">        &gt;&gt;&gt; sim = be.Simulation.init(n_periods=50, seed=42)</span>
<span class="sd">        &gt;&gt;&gt; sim.run()  # Runs for 50 periods</span>

<span class="sd">        Collect results with default settings:</span>

<span class="sd">        &gt;&gt;&gt; sim = be.Simulation.init(seed=42)</span>
<span class="sd">        &gt;&gt;&gt; results = sim.run(n_periods=100, collect=True)</span>
<span class="sd">        &gt;&gt;&gt; df = results.to_dataframe()</span>
<span class="sd">        &gt;&gt;&gt; results.economy_metrics.plot()</span>

<span class="sd">        Custom data collection:</span>

<span class="sd">        &gt;&gt;&gt; results = sim.run(collect={</span>
<span class="sd">        ...     &#39;roles&#39;: [&#39;Producer&#39;],</span>
<span class="sd">        ...     &#39;variables&#39;: {&#39;Producer&#39;: [&#39;price&#39;, &#39;inventory&#39;]},</span>
<span class="sd">        ...     &#39;aggregate&#39;: None,  # full per-agent data</span>
<span class="sd">        ... })</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - Each period corresponds to one execution of the full event pipeline</span>
<span class="sd">        - State is mutated in-place regardless of collect parameter</span>
<span class="sd">        - Simulation halts early if economy is destroyed (all firms/banks bankrupt)</span>
<span class="sd">        - For step-by-step execution with custom logic, use `step()` instead</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        step : Execute a single simulation period</span>
<span class="sd">        init : Initialize simulation with configuration</span>
<span class="sd">        SimulationResults : Container for collected simulation data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">n_periods</span> <span class="k">if</span> <span class="n">n_periods</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_periods</span>

        <span class="c1"># Set up collector if requested</span>
        <span class="n">collector</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">collect</span><span class="p">:</span>
            <span class="n">collector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_collector</span><span class="p">(</span><span class="n">collect</span><span class="p">)</span>

        <span class="c1"># Run simulation</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">collector</span><span class="p">:</span>
                <span class="n">collector</span><span class="o">.</span><span class="n">capture</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Return results if collecting</span>
        <span class="k">if</span> <span class="n">collector</span><span class="p">:</span>
            <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;n_periods&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">),</span>
                <span class="s2">&quot;n_firms&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_firms</span><span class="p">,</span>
                <span class="s2">&quot;n_households&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_households</span><span class="p">,</span>
                <span class="s2">&quot;n_banks&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_banks</span><span class="p">,</span>
                <span class="s2">&quot;seed&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">seed</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;seed&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;runtime_seconds&quot;</span><span class="p">:</span> <span class="n">elapsed</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">config_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;h_rho&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">h_rho</span><span class="p">,</span>
                <span class="s2">&quot;h_xi&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">h_xi</span><span class="p">,</span>
                <span class="s2">&quot;h_phi&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">h_phi</span><span class="p">,</span>
                <span class="s2">&quot;h_eta&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">h_eta</span><span class="p">,</span>
                <span class="s2">&quot;max_M&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_M</span><span class="p">,</span>
                <span class="s2">&quot;max_H&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_H</span><span class="p">,</span>
                <span class="s2">&quot;max_Z&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_Z</span><span class="p">,</span>
                <span class="s2">&quot;theta&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">theta</span><span class="p">,</span>
                <span class="s2">&quot;beta&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span>
                <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span>
                <span class="s2">&quot;r_bar&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">r_bar</span><span class="p">,</span>
                <span class="s2">&quot;v&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">v</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">collector</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">config_dict</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_create_collector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collect</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create data collector from collect parameter.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        collect : bool or dict</span>
<span class="sd">            Collection configuration (True for defaults, dict for custom).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        _DataCollector</span>
<span class="sd">            Configured data collector instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">bamengine.results</span><span class="w"> </span><span class="kn">import</span> <span class="n">_DataCollector</span>

        <span class="c1"># Get all role names</span>
        <span class="n">all_roles</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Producer&quot;</span><span class="p">,</span> <span class="s2">&quot;Worker&quot;</span><span class="p">,</span> <span class="s2">&quot;Employer&quot;</span><span class="p">,</span> <span class="s2">&quot;Borrower&quot;</span><span class="p">,</span> <span class="s2">&quot;Lender&quot;</span><span class="p">,</span> <span class="s2">&quot;Consumer&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">collect</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># Default: all roles, aggregated means, include economy</span>
            <span class="k">return</span> <span class="n">_DataCollector</span><span class="p">(</span>
                <span class="n">roles</span><span class="o">=</span><span class="n">all_roles</span><span class="p">,</span>
                <span class="n">variables</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">include_economy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">aggregate</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Custom configuration</span>
            <span class="k">return</span> <span class="n">_DataCollector</span><span class="p">(</span>
                <span class="n">roles</span><span class="o">=</span><span class="n">collect</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;roles&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">all_roles</span><span class="p">,</span>
                <span class="n">variables</span><span class="o">=</span><span class="n">collect</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;variables&quot;</span><span class="p">),</span>
                <span class="n">include_economy</span><span class="o">=</span><span class="n">collect</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;economy&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
                <span class="n">aggregate</span><span class="o">=</span><span class="n">collect</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;aggregate&quot;</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">),</span>
            <span class="p">)</span>

<div class="viewcode-block" id="Simulation.step">
<a class="viewcode-back" href="../../api/generated/bamengine.Simulation.html#bamengine.Simulation.step">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute one simulation period through the event pipeline.</span>

<span class="sd">        Advances the economy by exactly one period, executing all events in the</span>
<span class="sd">        pipeline in the order specified. This is the core execution method called</span>
<span class="sd">        by `run()`. Users can call this directly for fine-grained control between</span>
<span class="sd">        periods.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">            State is mutated in-place. The period counter (`sim.t`) is incremented</span>
<span class="sd">            by 1. If the economy is destroyed (all firms/banks bankrupt), execution</span>
<span class="sd">            halts immediately.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        Step through simulation manually with intermediate analysis:</span>

<span class="sd">        &gt;&gt;&gt; import bamengine as be</span>
<span class="sd">        &gt;&gt;&gt; sim = be.Simulation.init(seed=42)</span>
<span class="sd">        &gt;&gt;&gt; for period in range(100):</span>
<span class="sd">        ...     sim.step()</span>
<span class="sd">        ...     if period % 10 == 0:</span>
<span class="sd">        ...         unemployment = sim.ec.unemp_rate_history[-1]</span>
<span class="sd">        ...         print(f&quot;Period {period}: Unemployment = {unemployment:.2%}&quot;)</span>
<span class="sd">        Period 0: Unemployment = 8.40%</span>
<span class="sd">        Period 10: Unemployment = 5.20%</span>
<span class="sd">        Period 20: Unemployment = 4.80%</span>
<span class="sd">        ...</span>

<span class="sd">        Modify pipeline before stepping:</span>

<span class="sd">        &gt;&gt;&gt; sim = be.Simulation.init(seed=42)</span>
<span class="sd">        &gt;&gt;&gt; # Remove a specific event from the pipeline</span>
<span class="sd">        &gt;&gt;&gt; sim.pipeline.remove(&quot;firms_pay_dividends&quot;)</span>
<span class="sd">        &gt;&gt;&gt; sim.step()  # Executes modified pipeline</span>

<span class="sd">        Conditional execution based on economy state:</span>

<span class="sd">        &gt;&gt;&gt; sim = be.Simulation.init(seed=42)</span>
<span class="sd">        &gt;&gt;&gt; while sim.t &lt; 100 and not sim.ec.destroyed:</span>
<span class="sd">        ...     sim.step()</span>
<span class="sd">        ...     avg_price = sim.ec.avg_mkt_price</span>
<span class="sd">        ...     if avg_price &gt; 2.0:</span>
<span class="sd">        ...         print(f&quot;High prices detected at period {sim.t}&quot;)</span>
<span class="sd">        ...         break</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - Executes all events in `sim.pipeline` in order</span>
<span class="sd">        - Increments period counter (`sim.t`) before pipeline execution</span>
<span class="sd">        - Halts immediately if `sim.ec.destroyed` is True (economy collapse)</span>
<span class="sd">        - For bulk execution over many periods, use `run()` instead</span>
<span class="sd">        - Pipeline can be modified between calls to `step()`</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        run : Execute multiple periods</span>
<span class="sd">        pipeline : Event pipeline (can be modified before stepping)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ec</span><span class="o">.</span><span class="n">destroyed</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Execute pipeline</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ec</span><span class="o">.</span><span class="n">destroyed</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;SIMULATION TERMINATED&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Simulation.get_role">
<a class="viewcode-back" href="../../api/generated/bamengine.Simulation.html#bamengine.Simulation.get_role">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_role</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get role instance by name.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            Role name (case-insensitive): &#39;Producer&#39;, &#39;Worker&#39;, &#39;Employer&#39;,</span>
<span class="sd">            &#39;Borrower&#39;, &#39;Lender&#39;, &#39;Consumer&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Role</span>
<span class="sd">            Role instance from simulation.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        KeyError</span>
<span class="sd">            If role name not found.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; sim = Simulation.init()</span>
<span class="sd">        &gt;&gt;&gt; prod = sim.get_role(&quot;Producer&quot;)</span>
<span class="sd">        &gt;&gt;&gt; assert prod is sim.prod</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">bamengine.core.registry</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_role</span> <span class="k">as</span> <span class="n">get_role_class</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">bamengine.core.registry</span><span class="w"> </span><span class="kn">import</span> <span class="n">list_roles</span>

        <span class="c1"># Try to get the role class from registry (case-sensitive first)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># First try exact match</span>
            <span class="n">role_cls</span> <span class="o">=</span> <span class="n">get_role_class</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1"># Try case-insensitive match</span>
            <span class="n">name_title</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>  <span class="c1"># Convert to TitleCase</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">role_cls</span> <span class="o">=</span> <span class="n">get_role_class</span><span class="p">(</span><span class="n">name_title</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="c1"># Provide helpful error message</span>
                <span class="n">available</span> <span class="o">=</span> <span class="n">list_roles</span><span class="p">()</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Role &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; not found. Available roles: </span><span class="si">{</span><span class="n">available</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>

        <span class="c1"># Map role class to instance</span>
        <span class="n">instance_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">type</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">Producer</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">prod</span><span class="p">,</span>
            <span class="n">Worker</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrk</span><span class="p">,</span>
            <span class="n">Employer</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">emp</span><span class="p">,</span>
            <span class="n">Borrower</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bor</span><span class="p">,</span>
            <span class="n">Lender</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lend</span><span class="p">,</span>
            <span class="n">Consumer</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">con</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">role_cls</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">instance_map</span><span class="p">:</span>
            <span class="c1"># This shouldn&#39;t happen unless new roles are added without updating Simulation</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Role &#39;</span><span class="si">{</span><span class="n">role_cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39; is registered but not available in simulation&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">instance_map</span><span class="p">[</span><span class="n">role_cls</span><span class="p">]</span></div>


<div class="viewcode-block" id="Simulation.get_event">
<a class="viewcode-back" href="../../api/generated/bamengine.Simulation.html#bamengine.Simulation.get_event">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get event instance from pipeline by name.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            Event name (e.g., &#39;firms_adjust_price&#39;).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Event</span>
<span class="sd">            Event instance from current pipeline.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        KeyError</span>
<span class="sd">            If event not found in pipeline.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; sim = Simulation.init()</span>
<span class="sd">        &gt;&gt;&gt; pricing_event = sim.get_event(&quot;firms_adjust_price&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">bamengine.core.registry</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_event</span> <span class="k">as</span> <span class="n">get_event_class</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">bamengine.core.registry</span><span class="w"> </span><span class="kn">import</span> <span class="n">list_events</span>

        <span class="c1"># First try to find by exact name match in pipeline</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">events</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">event</span>

        <span class="c1"># If not found, check if it&#39;s a valid event in registry</span>
        <span class="c1"># This provides better error messages</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">get_event_class</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>  <span class="c1"># Just to check if it exists</span>
            <span class="c1"># Event exists in registry but not in current pipeline</span>
            <span class="n">pipeline_events</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">events</span><span class="p">[:</span><span class="mi">5</span><span class="p">]]</span>  <span class="c1"># TODO cover</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Event &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; is registered but not in current pipeline. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Pipeline events (first 5): </span><span class="si">{</span><span class="n">pipeline_events</span><span class="si">}</span><span class="s2">...&quot;</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1"># Event doesn&#39;t exist in registry at all</span>
            <span class="n">available</span> <span class="o">=</span> <span class="n">list_events</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Event &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; not found. Available events in registry: </span><span class="si">{</span><span class="n">available</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span></div>


<div class="viewcode-block" id="Simulation.get_relationship">
<a class="viewcode-back" href="../../api/generated/bamengine.Simulation.html#bamengine.Simulation.get_relationship">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_relationship</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get relationship instance by name.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            Relationship name (case-insensitive): &#39;LoanBook&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Relationship</span>
<span class="sd">            Relationship instance from simulation.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        KeyError</span>
<span class="sd">            If relationship name not found.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; sim = Simulation.init()</span>
<span class="sd">        &gt;&gt;&gt; lb = sim.get_relationship(&quot;LoanBook&quot;)</span>
<span class="sd">        &gt;&gt;&gt; assert lb is sim.lb</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">bamengine.core.registry</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_relationship</span> <span class="k">as</span> <span class="n">get_relationship_class</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">bamengine.core.registry</span><span class="w"> </span><span class="kn">import</span> <span class="n">list_relationships</span>

        <span class="c1"># Try to get the relationship class from registry (case-sensitive first)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># First try exact match</span>
            <span class="n">rel_cls</span> <span class="o">=</span> <span class="n">get_relationship_class</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1"># Try case-insensitive match - check each registered name</span>
            <span class="k">for</span> <span class="n">registered_name</span> <span class="ow">in</span> <span class="n">list_relationships</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">registered_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">rel_cls</span> <span class="o">=</span> <span class="n">get_relationship_class</span><span class="p">(</span><span class="n">registered_name</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Provide helpful error message</span>
                <span class="n">available</span> <span class="o">=</span> <span class="n">list_relationships</span><span class="p">()</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Relationship &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; not found. Available relationships: </span><span class="si">{</span><span class="n">available</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>

        <span class="c1"># Map relationship class to instance</span>
        <span class="n">instance_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">type</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">LoanBook</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lb</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">rel_cls</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">instance_map</span><span class="p">:</span>
            <span class="c1"># This shouldn&#39;t happen unless new relationships are added without updating Simulation</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Relationship &#39;</span><span class="si">{</span><span class="n">rel_cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39; is registered but not available in simulation&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">instance_map</span><span class="p">[</span><span class="n">rel_cls</span><span class="p">]</span></div>


<div class="viewcode-block" id="Simulation.get">
<a class="viewcode-back" href="../../api/generated/bamengine.Simulation.html#bamengine.Simulation.get">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get role, event or relationship by name.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            Role, event or relationship name.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Role | Event | Relationship</span>
<span class="sd">            Role, event or relationship instance from simulation.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If name not found in simulation.</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        Searches roles first, then events, then relationships.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; sim = Simulation.init()</span>
<span class="sd">        &gt;&gt;&gt; prod = sim.get(&quot;Producer&quot;)</span>
<span class="sd">        &gt;&gt;&gt; event = sim.get(&quot;firms_adjust_price&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_role</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_event</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; not found in simulation.&quot;</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Kostas Ganitis.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>